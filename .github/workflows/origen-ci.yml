name: Origen CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'origen/**'
      - '.github/workflows/origen-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'origen/**'

defaults:
  run:
    working-directory: origen

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby 2.7
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
        bundler-cache: false
        working-directory: origen
    
    - name: Install dependencies
      run: bundle install --jobs 4 --retry 3
    
    - name: Run RSpec tests
      run: bundle exec rspec --format documentation
    
    - name: Generate test coverage report
      if: always()
      run: bundle exec rspec --format json --out test-results.json || true
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: origen-test-results
        path: origen/coverage/
        if-no-files-found: ignore

  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby 2.7
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
        bundler-cache: false
        working-directory: origen
    
    - name: Install dependencies
      run: bundle install --jobs 4 --retry 3
    
    - name: Run RuboCop
      run: bundle exec rubocop --format simple

  pattern-generation:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby 2.7
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
        bundler-cache: false
        working-directory: origen
    
    - name: Install dependencies
      run: bundle install --jobs 4 --retry 3
    
    - name: Generate patterns
      run: |
        # Simulate pattern generation
        echo "Generating patterns..."
        mkdir -p output/patterns
        echo "Pattern generation complete" > output/patterns/generation_log.txt
    
    - name: Validate generated patterns
      run: |
        if [ -d "output/patterns" ]; then
          echo "âœ“ Pattern output directory created"
          ls -la output/patterns/
        else
          echo "âœ— Pattern generation failed"
          exit 1
        fi
    
    - name: Upload generated patterns
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generated-patterns
        path: origen/output/
        if-no-files-found: warn
